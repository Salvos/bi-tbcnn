#!/bin/sh
if [ ! -f /tmp/convert ]; then
	cat > /tmp/convert <<EOF
#!/bin/bash
src_file=\$1
mkdir -p /ast/\$(dirname \$src_file)
if [ "\${src_file/.python/}" == "\${src_file}" ]; then
	json_file=/ast/\$src_file.json
	pkl_file=/ast/\$src_file.pkl
	if [ ! -f \$json_file ]; then
		fbs_file=/ast/\$src_file.fbs
		if [ ! -f \$fbs_file ]; then
			fast -S -G \$src_file \$fbs_file > /dev/null
		fi
		ggnn \$fbs_file \$json_file
		fast \$fbs_file \$pkl_file
		rm -f \$fbs_file
	fi
fi
EOF
	chmod +x /tmp/convert
fi
cd /code 
ls | while read f; do
	if [ -d $f ]; then
		parallel --eta /tmp/convert ::: $f/*/*
	fi
done
cd -
